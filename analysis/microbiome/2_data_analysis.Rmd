---
title: "R Notebook"
output:
  html_notebook: default
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r packages, warning = FALSE}
library(tidyverse) 
library(vegan)
#library(pairwiseAdonis)
library(compositions)
#library(ggvenn)
#library(ggdendro)
library(GGally)
library(ggrepel)
library(patchwork)
library(tidylog)
library(ALDEx2)
library(viridis)
```

```{r raw-data}
raw_asv <- read_csv("output/asv_raw.csv")

sample_list <- read_csv("data/sample_labels.csv") |> 
  filter(tissue != "dyctiota" & month == "october")

env <- read_csv("data/environmental.csv")

exp_meta <- read_csv("data/exp_metadata.csv")
```

Some of the taxa can be resolved to a slightly better resolution and we filter chloroplasts out

```{r taxa-renaming}
raw_asv <- raw_asv |> 
  mutate(Family = ifelse(Class == "NB1-j", 
                        "NB1-j",
                        Family)) |> 
  mutate(Order = case_when(
    Class == "Marinimicrobia (SAR406 clade)" ~ "Deltaproteobacteria",
    Class == "NB1-j" ~ "Deltaproteobacteria",
    TRUE ~ Order)) |> 
  mutate(Class = case_when(
    Class == "Marinimicrobia (SAR406 clade)" ~ "Marinimicrobia",
    Class == "SAR324 clade(Marine group B)" ~ "Proteobacteria",
    Class == "NB1-j" ~ "Proteobacteria",
    Class == "WPS-2" ~ "Eremiobacterota (WPS-2)",
    is.na(Class) ~ "Unidentified Bacteria",
    TRUE ~ Class)) |> 
  filter(Family != "Chloroplast")
```


```{r count-data}
asv_taxa <- raw_asv |> 
  mutate(id = paste("asv", seq(1:nrow(raw_asv)), sep = "")) |>
  dplyr::select(c(1, 27:33))

asv_counts <- raw_asv |>
  dplyr::select(-c(1, 27:32)) |> #remove taxonomical information
  mutate(id = paste("asv", seq(1:nrow(raw_asv)), sep = "")) |> 
  pivot_longer(-id, names_to = "sample", values_to = "counts") |>  
  pivot_wider(values_from = counts, names_from = id) |> 
  mutate(sample = str_remove(sample, "_S.*"))
```

```{r taxa-names}
colnames(asv_taxa)

colnames(asv_taxa) <- c("ASV", "Domain", "Phylum", "Class", "Order", "Family", "Genus", "id")
```


Abundance of zeroes

```{r verification-zeroes}
raw_asv |>  
  #dplyr::select(where(is.numeric)) |>  
  rowwise() |> 
  mutate(total = sum(c_across(2:26))) |> 
 dplyr::select(total) |> 
  filter(total == 0)

rows_zeros <- asv_counts |>  
  #dplyr::select(where(is.numeric)) |>  
  rowwise() |> 
  mutate(total = sum(c_across(2:1897))) |>
  dplyr::select(sample, total) |> 
  filter(total == 0)

rows_zeros

asv_counts |>  
  #dplyr::select(where(is.numeric)) |>  
  rowwise() |> 
  mutate(total = sum(c_across(2:1897))) |>
  dplyr::select(total) |> 
  filter(total == 1)

checkNumZerosCol <- apply(asv_counts,2,function(x) sum(x==0))

cases <- which(checkNumZerosCol == (nrow(asv_counts) - 1))

length(cases) 
```

After removing chloroplasts, one row becomes all zero, which needs to be removed

```{r count-cleaning}
asv_counts <- asv_counts |> 
  filter(sample %in% sample_list$sample) |> 
  filter(!(sample %in% rows_zeros$sample))

asv_counts <- asv_counts[,-cases]
```

## Data transformation

One option would be to use the zCompositions::cmultRepl() method, however, in order to keep consistency, we can use the approach implemented in the Aldex2 package

```{r clr, eval=FALSE, include=FALSE}
# asv_counts |>  
#   dplyr::select(where(is.numeric)) |> 
#   cmultRepl(method = "SQ", output = "prop") |>  #zero handling
#   compositions::clr() #clr-normalization
```

```{r clr}
asv_props <- asv_counts |>  
  dplyr::select(where(is.numeric)) |> 
  mutate(across(everything(),
         ~.x +0.5)) |> 
  compositions::clr() #clr-normalization
```

### Permanova and permdisp

```{r permanova}
anova_factors <- data.frame(asv_counts$sample) |> 
  rename(sample = "asv_counts.sample") |> 
  left_join(sample_list) |> 
   tidylog::filter(!(sample %in% rows_zeros$sample)) |> 
  tidylog::select(sample, treatment, compartment) 

anova_factors$interaction <-  paste(anova_factors$treatment, 
                                    anova_factors$compartment, sep = "-")

set.seed(1)
asv_props |> 
  data.frame() |>
  # mutate(month = sample_list$month) |> 
  # filter(month == "october") |> 
  dplyr::select(where(is.numeric)) |> 
  (\(x) {adonis2(formula = x~anova_factors$treatment*anova_factors$compartment,
                method = "euclidean",
                permutations = 9999)})()
set.seed(1)
asv_props |> 
  data.frame() |>
  # mutate(compartment = sample_list$compartment,
  #        treatment = sample_list$treatment,
  #        month = sample_list$month) |> 
  # filter(month == "october") |> 
  # dplyr::select(where(is.numeric)) |> 
  vegdist(method = "euclidean") |> 
  betadisper(group = anova_factors$interaction) |> 
  permutest()
```

### Ordination

```{r pco-ordination}
pco_ord <- asv_props |> 
  vegdist(method = "euclidean") |> 
  labdsv::pco(k = 3)
  
x_expv <- round(100*(pco_ord$eig[c(1)]/sum(pco_ord$eig)))
y_expv <- round(100*(pco_ord$eig[c(2)]/sum(pco_ord$eig)))

pco_ord$points |> 
  data.frame() |> 
  mutate(Compartment = anova_factors$compartment,
         Treatment = anova_factors$treatment) |>
  #filter(month == "october") |> 
  ggplot() +
  geom_point(aes(x = X1, y = X2, 
                 shape = Compartment, 
                 color = Treatment
                 ),
             size = 5) +
  labs(x = paste("PCo 1 (",
                 x_expv,
                 "% of explained variance)",
                 sep = ""),
       y = paste("PCo 2 (",
                 y_expv,
                 "% of explained variance)",
                 sep = ""),
       shape = "Compartment",
       color = "Environment") + 
  scale_shape_discrete(labels = c("Leaf", "Rhizome", "Water column")) +
  scale_color_discrete(labels = c("Acidified", "Control")) +
  theme_bw() +
  theme(legend.position = "bottom")

#ggsave("figures/pco_compartments.svg")

round(100*(pco_ord$eig[c(1,2)]/sum(pco_ord$eig)))
```

Clearly the rhizome samples have a completely different pattern from the leaves and water column samples. For this reason, and also because of the main scope of the paper, we can redo the analysis without those samples.


# Analysis without the rhizome samples

Let's remove the rhizome samples from the dataset and transform again with the clr

```{r no-rhizomes}
lw_counts <- asv_counts |> 
  filter(!(str_detect(sample, "sgr")))

lw_props <- lw_counts |>  
  dplyr::select(where(is.numeric)) |> 
  mutate(across(everything(),
         ~.x +0.5)) |> 
  compositions::clr() #clr-normalization
```

```{r pco-no-rhizome}
pco_lw <- lw_props |> 
  vegdist(method = "euclidean") |> 
  labdsv::pco(k = 3)
  
x_expv_lw <- round(100*(pco_lw$eig[c(1)]/sum(pco_lw$eig)))
y_expv_lw <- round(100*(pco_lw$eig[c(2)]/sum(pco_lw$eig)))

pco_plot_lw <- pco_lw$points |> 
  data.frame() |> 
  mutate(Compartment = anova_factors[anova_factors$compartment!="rhizome",]$compartment,
         Treatment = anova_factors[anova_factors$compartment!="rhizome",]$treatment) |>
  #filter(month == "october") |> 
  ggplot() +
  geom_point(aes(x = X1, y = X2, 
                 shape = Compartment, 
                 color = Treatment
                 ),
             size = 5) +
  labs(x = paste("PCo 1 (",
                 x_expv,
                 "% of explained variance)",
                 sep = ""),
       y = paste("PCo 2 (",
                 y_expv,
                 "% of explained variance)",
                 sep = ""),
       shape = "Compartment",
       color = "pH") + 
  scale_shape_discrete(labels = c("Leaf", "Water column")) +
  scale_color_discrete(labels = c("Vent", "Ambient")) +
  theme_bw() +
  theme(legend.position = "bottom")

pco_plot_lw

ggsave("figures/pco_compartments.svg")

round(100*(pco_ord$eig[c(1,2)]/sum(pco_ord$eig)))
```

### Venn Diagrams

```{r venn-diagram}
# venn_comp <- asv_counts |> 
#   left_join(sample_list) |>
#   filter(month == "october") |> 
#   dplyr::select(-c(experiment, tissue, treatment, month, year, sample)) |> 
#   pivot_longer(names_to = "asv", values_to = "count", -compartment) %>% 
#   # left_join(ext_taxa) %>% 
#   # dplyr::select(month, count, asv) %>% 
#   group_by(compartment, asv) %>% 
#   summarise(total=sum(count)) %>% 
#   mutate(present = total != 0) %>% 
#   dplyr::select(-total) %>% 
#   pivot_wider(asv, names_from = compartment, values_from = present)
# 
# ggvenn(venn_comp[,-1])
```

### Taxonomical composition

```{r phyla-composition-heat}
tcp_A <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Phylum, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcp_B <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Phylum, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcp_C <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Phylum, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcp_D <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Phylum, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcp_A + tcp_B + tcp_C + tcp_D
ggsave("figures/phyla_composition_heat.svg")
```

As stacked bars:

```{r phyla-composition-bars}
bpa_A <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Phylum),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

bpa_B <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Phylum),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

bpa_C <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Phylum),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

bpa_D <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Phylum, treatment, compartment) |>  
  group_by(sample, Phylum, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Phylum),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))



bpa_A + bpa_B + bpa_C + bpa_D
```

```{r phyla-composition-bars-avg}
set.seed(3)
cols = turbo(26)[sample(1:26,26)]

lw_props |>
  compositions::clrInv() |>
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |>
  pivot_longer(names_to = "asv",
               values_to = "props",
               -c(compartment, treatment,sample)
               ) |>
  mutate(compartment = ifelse(compartment == "leaves", "Leaves", "Water column"),
         treatment = ifelse(treatment == "vent", "Vent", "Ambient")) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |>
  dplyr::select(props, sample, Phylum, treatment, compartment) |>
  group_by(sample, Phylum, treatment, compartment) |>
  summarise(total = sum(props), weight = n()) |>
  group_by(Phylum, treatment, compartment) |>
  summarise(avg = mean(total)) |>
  ggplot() +
  geom_bar(aes(y = avg, x = treatment, fill = Phylum),
           position = "stack", stat = "identity") +
  facet_grid(~compartment) +
  labs(y = "Proportion") +
  scale_fill_manual(values = cols) +
  theme_minimal() +
  #scale_fill_viridis(discrete = TRUE, option = "turbo") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "bottom") 

#ggsave("figures/phyla_composition_stacked.svg")
ggsave("figures/phyla_composition_stacked.png")
```

```{r class-composition-bars-avg}
set.seed(3)
cols = turbo(39)[sample(1:39,39)]

lw_props |>
  compositions::clrInv() |>
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |>
  pivot_longer(names_to = "asv",
               values_to = "props",
               -c(compartment, treatment,sample)
               ) |>
  mutate(compartment = ifelse(compartment == "leaves", "Leaves", "Water column"),
         treatment = ifelse(treatment == "vent", "Vent", "Ambient")) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |>
  dplyr::select(props, sample, Class, treatment, compartment) |>
  group_by(sample, Class, treatment, compartment) |>
  summarise(total = sum(props), weight = n()) |>
  group_by(Class, treatment, compartment) |>
  summarise(avg = mean(total)) |>
  ggplot() +
  geom_bar(aes(y = avg, x = treatment, fill = Class),
           position = "stack", stat = "identity") +
  facet_grid(~compartment) +
  labs(y = "Proportion", x = "pH regime") +
  scale_fill_manual(values = cols) +
  theme_minimal() +
  #scale_fill_viridis(discrete = TRUE, option = "turbo") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "bottom") 

#ggsave("figures/phyla_composition_stacked.svg")
#ggsave("figures/phyla_composition_stacked.png")
```

```{r class-composition-heat}
tcc_A <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Class, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcc_B <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Class, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcc_C <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Class, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcc_D <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |>
  ggplot() +
  geom_tile(aes(y = Class, x = sample, fill = total)) +
  #facet_grid(compartment~treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

tcc_A + tcc_B + tcc_C + tcc_D

#ggsave("figures/class_composition_heat.svg")
```

```{r class-composition-heat-avg}
# set.seed(3)
# cols = turbo(26)[sample(1:39,39)]

lw_props |>
  compositions::clrInv() |>
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |>
  pivot_longer(names_to = "asv",
               values_to = "props",
               -c(compartment, treatment,sample)
               ) |>
  mutate(compartment = ifelse(compartment == "leaves", "Leaves", "Water column"),
         treatment = ifelse(treatment == "vent", "Vent", "Ambient")) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |>
  dplyr::select(props, sample, Class, treatment, compartment) |>
  group_by(sample, Class, treatment, compartment) |>
  summarise(total = sum(props), weight = n()) |>
  group_by(Class, treatment, compartment) |>
  summarise(avg = mean(total)) |>
  ggplot() +
  geom_tile(aes(y = Class, x = treatment, fill = avg)) +
  facet_grid(~compartment) +
  labs(y = "Proportion") +
  #scale_fill_manual(values = cols) +
  theme_minimal() +
  #scale_fill_viridis(discrete = TRUE, option = "turbo") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "bottom") 

#ggsave("figures/phyla_composition_stacked.svg")
#ggsave("figures/phyla_composition_stacked.png")
```

```{r class-comp-bars}
bcc_A <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Class),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

bcc_B <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "leaves") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Class),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

bcc_C <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "ambient" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Class),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

bcc_D <- lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::filter(treatment == "vent" & compartment == "water_column") |> 
  #dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment,sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::select(props, sample, Class, treatment, compartment) |>  
  group_by(sample, Class, treatment, compartment) |>  
  summarise(total=sum(props)) |> 
  ggplot() +
  geom_bar(aes(y = total, x = sample, fill = Class),
           position="stack", stat="identity") +
  facet_grid(compartment~treatment) +
  scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))



bcc_A + bcc_B + bcc_C + bcc_D
```

Selecting only the Proteobacteria

```{r prote-comp-heat}
lw_props |>   
  compositions::clrInv() |> 
  cbind(anova_factors[anova_factors$compartment!="rhizome",]) |> 
  dplyr::select(-interaction) |> 
  pivot_longer(names_to = "asv", 
               values_to = "props", 
               -c(compartment, treatment, asv_counts.sample)
               ) |> 
  left_join(asv_taxa, by = c("asv" = "id")) |> 
  dplyr::filter(Phylum == "Proteobacteria") |> 
  dplyr::select(props,asv_counts.sample, Class) |>  
  group_by(asv_counts.sample, Class) |>  
  summarise(total=sum(props)) |>  
  pivot_wider(names_from = Class, values_from = total) |> 
  data.frame() |> 
  mutate(Compartment = anova_factors[anova_factors$compartment!="rhizome",]$compartment,
         Treatment = anova_factors[anova_factors$compartment!="rhizome",]$treatment) |> 
  pivot_longer(-c(Treatment, Compartment, asv_counts.sample), 
               names_to = "Taxa", values_to = "props") |> 
  ggplot() +
  geom_tile(aes(y = Taxa, x = Compartment, fill = props)) +
  facet_grid(~Treatment) +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## Classification analysis


# Differential abundance analysis

## Including rhizomes

```{r DA-compartment}
covariates <- anova_factors |>
   #filter(compartment != "rhizome") |>
  dplyr::select(asv_counts.sample , compartment) |>
  arrange(asv_counts.sample) |>
  mutate(value = 1) |>
  pivot_wider(names_from = compartment, values_from = value, values_fill = 0) |>
  dplyr::select(-asv_counts.sample)

mm <- model.matrix(~leaves+rhizome+water_column, covariates)

aldex_full_out <- asv_counts |> 
  pivot_longer(names_to = "asv", values_to = "counts", -sample) |> 
  pivot_wider(names_from = sample, values_from = counts) |> 
  column_to_rownames("asv") |> 
  aldex.clr(conds = mm,
            verbose = TRUE)

glm_out <- aldex.glm(aldex_full_out, verbose = TRUE)
glm_eff <- aldex.glm.effect(aldex_full_out, CI = TRUE)
```

## Volcano plots

```{r volcano-full-denom}
glm_eff[["leaves"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) +
  geom_hline(yintercept = 0.3) +
  geom_vline(xintercept = 0.5) +
  labs(y = "Overlap", x = "Effect", title = "Leaves") +
  ylim(y = c(0, 0.5)) +
  # glm_eff[["rhizome"]] |> 
  # ggplot() +
  # geom_point(aes(x = effect, y = overlap), alpha = 0.25) + 
  # geom_hline(yintercept = 0.3) +
  # geom_vline(xintercept = 0.5) +
  # labs(x = "Effect", title = "Rhizome") +
  # theme(axis.title.y = element_blank()) +
  glm_eff[["water_column"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) +
  geom_hline(yintercept = 0.2) +
  geom_vline(xintercept = 0.5) +
  labs(x = "Effect", title = "Water column") +
  theme(axis.title.y = element_blank())
```

## Zoom in with Phyla

```{r DA-glm-leaves}
p1 <- glm_eff[["leaves"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), 
            mean_overlap=mean(overlap), total=n())|> 
  ggplot() +
  geom_point(aes(color = Phylum, y = mean_overlap, 
                 x = mean_effect, size = total)
             ) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Leaves")
```

```{r DA-glm-rhizome, eval=FALSE, include=FALSE}
p2 <- glm_eff[["rhizome"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> 
  group_by(Class) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n())|> 
  ggplot() +
  geom_point(aes(color = Class, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Rhizome")
```


```{r DA-glm-water}
p3 <- glm_eff[["water_column"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Phylum, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Water column")
```

```{r}
p1+p3
#ggsave("figures/differential_contribution_phyla.svg")
```

## Zoom in with Classses

```{r}
p4 <- glm_eff[["leaves"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> 
  group_by(Class) |> 
  summarise(mean_effect = mean(effect), 
            mean_overlap = mean(overlap), 
            total = n())|> 
  ggplot() +
  geom_point(aes(color = Class, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Leaves")
```

```{r}
p5 <- glm_eff[["rhizome"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> 
  group_by(Class) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n())|> 
  ggplot() +
  geom_point(aes(color = Class, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Rhizome")
```

```{r}
p6 <- glm_eff[["water_column"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> 
  group_by(Class) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Class, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Water column")
```

```{r}
p4 + p6

ggsave("figures/da__classes.svg")
```

## Zoom in with order
```{r}
p7 <- glm_eff[["leaves"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class, Order) |> 
  group_by(Class, Order) |> 
  summarise(mean_effect=mean(effect), 
            mean_overlap=mean(overlap), Total = n())|> 
  ggplot() +
  geom_point(aes(color = Class, y = mean_overlap, 
                 x = mean_effect, size = Total)
             ) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Order)) +
  labs(y = "Overlap", x = "Effect", title = "Leaves") +
  scale_color_viridis(discrete = TRUE, option = "H") +
  theme(legend.position = "right")
```

```{r DA-glm-rhizome, eval=FALSE, include=FALSE}
p8 <- glm_eff[["rhizome"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> 
  group_by(Class) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n())|> 
  ggplot() +
  geom_point(aes(color = Class, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Rhizome")
```


```{r DA-glm-water}
p9 <- glm_eff[["water_column"]] |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class, Order) |> 
  group_by(Class, Order) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), Total = n()) |> 
  ggplot() +
  geom_point(aes(color = Class, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = Total)
             ) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Order)) +
  labs(y = "Overlap", x = "Effect", title = "Water column") +
  scale_color_viridis(discrete = TRUE, option = "H") +
  scale_y_continuous(expand = expansion(mult = c(.15, .1))) +
  theme(legend.position = "right")
```

```{r}
p7 / p9

#ggsave("figures/da__classes.svg")
#ggsave("figures/da_order.svg")
```

## EXCLUDING rhizomes

```{r DA-compartment}
covariates <- anova_factors |>
   filter(compartment != "rhizome") |>
  dplyr::select(sample , compartment) |>
  arrange(sample) |>
  mutate(value = 1) |>
  pivot_wider(names_from = compartment, values_from = value, values_fill = 0) |>
  dplyr::select(leaves)

#mm <- model.matrix(~leaves, covariates)

aldex_full_out_tt <- asv_counts |> 
  pivot_longer(names_to = "asv", values_to = "counts", -sample) |> 
  dplyr::filter(!(str_detect(sample, "sgr"))) |> 
  pivot_wider(names_from = sample, values_from = counts) |> 
  column_to_rownames("asv") |>
  aldex.clr(conds = covariates$leaves,
            verbose = TRUE,
            denom = "zero")

tt_out <- aldex.ttest(aldex_full_out_tt, verbose = TRUE)
tt_eff <- aldex.effect(aldex_full_out_tt, CI = TRUE)
```

## PLot from kw

```{r}
tt_eff |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) 
  # geom_hline(yintercept = 0.3) +
  # geom_vline(xintercept = 0.5)
```


```{r}
kw_eff |> 
  filter(effect >= 0.5 & overlap < 0.3) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Order) |> 
  group_by(Order) |> 
  summarise(mean_effect=mean(effect), 
            mean_overlap=mean(overlap), total=n())|> 
  ggplot() +
  geom_point(aes(color = Order, y = mean_overlap, 
                 x = mean_effect, size = total)
             ) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Order)) +
  labs(y = "Overlap", x = "Effect", title = "Leaves")
```


# Correlation with environmental variables


As correlations to the PCO axes:

```{r}
points_leaves <- pco_lw$points |> 
  data.frame() |> 
  mutate(Compartment = anova_factors[anova_factors$compartment!="rhizome",]$compartment,
         Treatment = anova_factors[anova_factors$compartment!="rhizome",]$treatment) |>
  filter(Compartment == "leaves")
```


```{r correlations_axes}
vent_draft <- env |> 
  dplyr::filter(treatment == "vent") |> 
  dplyr::select(-treatment) |> 
  # bind_rows(data.frame(matrix(as.numeric(NA), 2, 9))) |> 
  # dplyr::select(-(10:18)) |> 
  cbind(bind_rows(points_leaves[,-c(4, 5)],
                  data.frame(matrix(as.numeric(NA), 2, 3)))) |> 
  ggpairs(upper = list(continuous = wrap("cor", method = "spearman")))



ambient_draft <- env |> 
  dplyr::filter(treatment == "ambient") |> 
  dplyr::select(-treatment) |> 
  bind_rows(data.frame(matrix(as.numeric(NA), 2, 9))) |> 
  dplyr::select(-(10:18)) |> 
  cbind(pco_lw$points) |> 
  ggpairs()
```

```{r}
 pco_lw$points |> 
  data.frame() |> 
  mutate(Compartment = anova_factors[anova_factors$compartment!="rhizome",]$compartment,
         Treatment = anova_factors[anova_factors$compartment!="rhizome",]$treatment) |>
  filter(Compartment == "leaves") |> 
  ggplot() +
  geom_point(aes(x = X1, y = X2, 
                 shape = Compartment, 
                 color = Treatment
                 ),
             size = 5) +
  labs(x = paste("PCo 1 (",
                 x_expv,
                 "% of explained variance)",
                 sep = ""),
       y = paste("PCo 2 (",
                 y_expv,
                 "% of explained variance)",
                 sep = ""),
       shape = "Compartment",
       color = "pH") + 
  scale_shape_discrete(labels = c("Leaf", "Water column")) +
  scale_color_discrete(labels = c("Vent", "Ambient")) +
  theme_bw() +
  theme(legend.position = "bottom")
```


```{r pco_vectors}
pco_plot_lw + 
  annotate("path",
           alpha = .2,
           x=0+50*cos(seq(0,2*pi,length.out=100)),
           y=0+50*sin(seq(0,2*pi,length.out=100))) +
   annotate('segment', #NH4
           x = 0,
           y = 0,
           xend = 50*-0.335,
           yend = 50*0.271,
           size = 0.5,
           color = 'black',
           alpha = .3) +
  annotate("text", 
           label = 'NH4 (v)',
           fontface = 'italic',
           x = 50*-0.34, 
           y = 50*0.28) +
  annotate('segment', #NO3
           x = 0,
           y = 0,
           xend = 50*-0.220,
           yend = 50*0.611,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'NO3 (v)',
           fontface = 'italic',
           x = 50*-0.23, 
           y = 50*0.62) +
  annotate('segment', #PO4
           x = 0,
           y = 0,
           xend = 50*-0.445,
           yend = 50*0.193,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'PO4 (v)',
           fontface = 'italic',
           x = 50*-0.45, 
           y = 50*0.20) +
  annotate('segment', #NO2
           x = 0,
           y = 0,
           xend = 50*-0.196,
           yend = 50*0.301,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'NO2 (v)',
           fontface = 'italic',
           x = 50*-0.20, 
           y = 50*0.31) +
  annotate('segment', #O2
           x = 0,
           y = 0,
           xend = 50*0.18,
           yend = 50*0.996,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'O2 (v)',
           fontface = 'italic',
           x = 50*0.19, 
           y = 50*1) +
    annotate('segment', #pH
           x = 0,
           y = 0,
           xend = 50*0.46,
           yend = 50*0.927,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'pH (v)',
           fontface = 'italic',
           x = 50*0.47, 
           y = 50*0.93) +
      annotate('segment', #NH4
           x = 0,
           y = 0,
           xend = 50*-0.301,
           yend = 50*0.179,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'NH4 (a)',
           fontface = 'italic',
           x = 50*-0.31, 
           y = 50*0.18) +
        annotate('segment', #NO3
           x = 0,
           y = 0,
           xend = 50*0.361,
           yend = 50*0.555,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'NO3 (a)',
           fontface = 'italic',
           x = 50*0.37, 
           y = 50*0.56) +
        annotate('segment', #PO4
           x = 0,
           y = 0,
           xend = 50*0.083,
           yend = 50*0.173,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'PO4 (a)',
           fontface = 'italic',
           x = 50*0.09, 
           y = 50*0.174) +
        annotate('segment', #NO2
           x = 0,
           y = 0,
           xend = 50*-0.505,
           yend = 50*0.405,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'NO2 (a)',
           fontface = 'italic',
           x = 50*-0.51, 
           y = 50*0.41) +
        annotate('segment', #pH
           x = 0,
           y = 0,
           xend = 50*-0.063,
           yend = 50*0.988,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'pH (a)',
           fontface = 'italic',
           x = 50*-0.07, 
           y = 50*1) +
        annotate('segment', #O2
           x = 0,
           y = 0,
           xend = 50*0.156,
           yend = 50*0.998,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'O2 (a)',
           fontface = 'italic',
           x = 50*0.16, 
           y = 50*1) +
  annotate('segment', #C
           x = 0,
           y = 0,
           xend = 50*-0.378,
           yend = 50*0.374,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'C (v)',
           fontface = 'italic',
           x = 50*-0.38, 
           y = 50*0.38) +
  annotate('segment', #N
           x = 0,
           y = 0,
           xend = 50*0.171,
           yend = 50*-0.137,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'N (v)',
           fontface = 'italic',
           x = 50*0.18, 
           y = 50*-0.14) +
  annotate('segment', #CN
           x = 0,
           y = 0,
           xend = 50*-0.224,
           yend = 50*0.219,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'C:N (v)',
           fontface = 'italic',
           x = 50*-0.23, 
           y = 50*0.22) +
  annotate('segment', #C
           x = 0,
           y = 0,
           xend = 50*0.88,
           yend = 50*-0.196,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'C (a)',
           fontface = 'italic',
           x = 50*0.9, 
           y = 50*-0.2) +
  annotate('segment', #N
           x = 0,
           y = 0,
           xend = 50*0.230,
           yend = 50*-0.300,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'N (a)',
           fontface = 'italic',
           x = 50*0.24, 
           y = 50*-0.31) +
  annotate('segment', #CN
           x = 0,
           y = 0,
           xend = 50*-0.276,
           yend = 50*0.318,
           size = 0.5,
           color = 'black',
           alpha = .3) +
    annotate("text", 
           label = 'C:N (a)',
           fontface = 'italic',
           x = 50*-0.28, 
           y = 50*0.32) 

#ggsave("figures/pco_vectors.svg")
```


## Rare phyla (compartment)

```{r volcano-plots}
glm_eff[["leaves"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) +
  geom_hline(yintercept = 0.3) +
  geom_vline(xintercept = c(0,0.5)) +
  labs(y = "Overlap", x = "Effect", title = "Leaves") +
  ylim(y = c(0, 0.5)) +
  glm_eff[["rhizome"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) + 
  geom_hline(yintercept = 0.3) +
  geom_vline(xintercept = c(0, 0.5)) +
  labs(x = "Effect", title = "Rhizome") +
  theme(axis.title.y = element_blank()) +
  glm_eff[["water_column"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) +
  geom_hline(yintercept = 0.2) +
  geom_vline(xintercept = c(0, 0.5)) +
  labs(x = "Effect", title = "Water column") +
  theme(axis.title.y = element_blank())
```

```{r da-leaves}
r1 <- glm_eff[["leaves"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  #filter(overlap < 0.3)
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect = mean(effect), 
            mean_overlap = mean(overlap), 
            total = n())|> 
  ggplot() +
  geom_point(aes(color = Phylum, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Leaves") +
  theme(legend.position = "none")
```

```{r da-rhizomes}
r2 <- glm_eff[["rhizome"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n())|> 
  ggplot() +
  geom_point(aes(color = Phylum, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Rhizome") +
  theme(legend.position = "none")
```

```{r da-water_colum}
r3 <- glm_eff[["water_column"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Phylum, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Water column") +
  theme(legend.position = "none")
```

```{r}
r1 + r3
ggsave("figures/rare_phyla_compartment.svg")
```

## Rare phyla (environment)

```{r da-leaves}
r4 <- glm_eff[["leaves"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  #filter(overlap < 0.3)
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> 
  group_by(Class) |> 
  summarise(mean_effect = mean(effect), 
            mean_overlap = mean(overlap), 
            total = n())|> 
  ggplot() +
  geom_point(aes(color = Class, y = mean_overlap, x = mean_effect, size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Leaves") +
  theme(legend.position = "none")
```



```{r da-water_colum}
r5 <- glm_eff[["water_column"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Phylum, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Water column") +
  theme(legend.position = "none")
```

```{r}
r4 + r5
#ggsave("figures/rare_classes_compartment.svg")
ggsave("figures/rare_phyla_compartment.png")
```

## Aldex rare acidified vs control

```{r}
covariates_b <- anova_factors |> 
  dplyr::select(asv_counts.sample, treatment) |> 
  arrange(asv_counts.sample) |>
  mutate(value = 1) |> 
  pivot_wider(names_from = treatment, 
              values_from = value, values_fill = 0) |>
  dplyr::select(-asv_counts.sample)

mm_b <- model.matrix(~vent+ambient, covariates_b)

aldex_out_rare <- asv_counts |>  
  left_join(sample_list) |>
  dplyr::select(-c(experiment, tissue, treatment, year, compartment)) |>
  filter(month == "october") |>
  filter(!(sample %in% rows_zeros$sample)) |> 
  dplyr::select(-month) |> 
  pivot_longer(names_to = "asv", values_to = "count", -sample) |>  
  pivot_wider(names_from = sample, values_from = count, values_fill = 0) |> 
  column_to_rownames("asv") |>
  dplyr::select(where(is.numeric)) |>
  aldex.clr(conds = mm_b) 
  
glm_out_b <- aldex.glm(aldex_out_rare, verbose = TRUE)
glm_eff_b <- aldex.glm.effect(aldex_out_rare, CI = TRUE)
```

## Volcano plots (rare)

```{r}
glm_eff_b[["ambient"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) +
  # geom_hline(yintercept = 0.3) +
  # geom_vline(xintercept = 0.5) +
  labs(y = "Overlap", x = "Effect", title = "Control") +
  ylim(y = c(0, 0.5)) +
  glm_eff_b[["vent"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) + 
  # geom_hline(yintercept = 0.3) +
  # geom_vline(xintercept = 0.5) +
  labs(x = "Effect", title = "Leaves") +
  theme(axis.title.y = element_blank())
```


```{r DA-phyla-environment}
r6 <- glm_eff_b[["vent"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> #actually order
  group_by(Phylum) |> 
  summarise(mean_effect = mean(effect), 
            mean_overlap = mean(overlap), 
            total = n()) |> 
  ggplot() +
  geom_point(aes(color = Phylum, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Vent") +
  theme(legend.position = "none")
```

```{r}
r7 <- glm_eff_b[["ambient"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Phylum, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", title = "Ambient") +
  theme(legend.position = "none")
```

```{r}
r6 + r7
ggsave("figures/rare_phya_environment.svg")
```

```{r DA-phyla-environment}
r8 <- glm_eff_b[["vent"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> #actually order
  group_by(Class) |> 
  summarise(mean_effect = mean(effect), 
            mean_overlap = mean(overlap), 
            total = n()) |> 
  ggplot() +
  geom_point(aes(color = Class, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Vent") +
  theme(legend.position = "none")
```

```{r}
r9 <- glm_eff_b[["ambient"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Class) |> 
  group_by(Class) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Class, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Class)) +
  labs(y = "Overlap", x = "Effect", title = "Ambient") +
  theme(legend.position = "none")
```

```{r}
r8 + r9
ggsave("figures/rare_class_environment.svg")
```

```{r}
r10 <- glm_eff_b[["ambient"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Order) |> 
  group_by(Order) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Order, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Order)) +
  labs(y = "Overlap", x = "Effect", title = "Ambient") +
  theme(legend.position = "none")
```

```{r}
r11 <- glm_eff_b[["vent"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Order) |> 
  group_by(Order) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Order, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Order)) +
  labs(y = "Overlap", x = "Effect", title = "Vent") +
  theme(legend.position = "none")
```

## Aldex environment without rhizome

```{r}
covariates_va <- anova_factors |> 
  dplyr::filter(compartment != "rhizome") |>
  arrange(sample) |>
  mutate(value = 1) |> 
  pivot_wider(names_from = treatment, 
              values_from = value, values_fill = 0) |>
  mutate(value = 1) |> 
  pivot_wider(names_from = compartment, 
              values_from = value, values_fill = 0) |> 
  dplyr::select(-sample)

mm_va <- model.matrix(~vent+ambient+leaves+water_column, covariates_va)

aldex_out_rare_va <- asv_counts |>  
  left_join(sample_list) |>
  dplyr::filter(compartment != "rhizome") |> 
  dplyr::select(-c(experiment, tissue, treatment, year, compartment, month, year)) |>
  filter(!(sample %in% rows_zeros$sample)) |> 
  pivot_longer(names_to = "asv", values_to = "count", -sample) |>  
  pivot_wider(names_from = sample, values_from = count, values_fill = 0) |> 
  column_to_rownames("asv") |>
  dplyr::select(where(is.numeric)) |>
  aldex.clr(conds = mm_va)
  
glm_out_va <- aldex.glm(aldex_out_rare_va, verbose = TRUE)
glm_eff_va <- aldex.glm.effect(aldex_out_rare_va, CI = TRUE)
```

```{r volcano-va}
glm_eff_va[["ambient"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) +
  # geom_hline(yintercept = 0.3) +
  # geom_vline(xintercept = 0.5) +
  labs(y = "Overlap", x = "Effect", 
       #title = "Control"
       ) +
  ylim(y = c(0, 0.5)) +
  glm_eff_va[["vent"]] |> 
  ggplot() +
  geom_point(aes(x = effect, y = overlap), alpha = 0.25) + 
  # geom_hline(yintercept = 0.3) +
  # geom_vline(xintercept = 0.5) +
  labs(x = "Effect", 
       #title = "Leaves"
       ) +
  theme(axis.title.y = element_blank())
```


```{r}
glm_eff_va[["vent"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Phylum, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", 
       title = "Vent"
       ) +
  theme(legend.position = "bottom") +
  guides(color = "none") +
  glm_eff_va[["ambient"]] |> 
  filter(effect < 0.5 & effect > 0) |> 
  rownames_to_column("asv") |> 
  left_join(asv_taxa, c("asv" = "id")) |> 
  dplyr::select(effect, overlap, Phylum) |> 
  group_by(Phylum) |> 
  summarise(mean_effect=mean(effect), mean_overlap=mean(overlap), total=n()) |> 
  ggplot() +
  geom_point(aes(color = Phylum, 
                 y = mean_overlap, 
                 x = mean_effect, 
                 size = total)) +
  geom_text_repel(aes(x = mean_effect, y = mean_overlap, 
                label = Phylum)) +
  labs(y = "Overlap", x = "Effect", 
       title = "Ambient"
       ) +
  guides(color = "none") +
  theme(legend.position = "bottom") 

ggsave("figures/rare_phyla_environment.png")
```


### aldex with subsets

```{r}
covariates_c <- anova_factors |> 
  dplyr::filter(compartment == "leaves") |> 
  dplyr::select(asv_counts.sample, treatment) |> 
  arrange(asv_counts.sample) |>
  mutate(value = 1) |> 
  pivot_wider(names_from = treatment, 
              values_from = value, values_fill = 0) |>
  dplyr::select(-asv_counts.sample)

mm_c <- model.matrix(~vent+ambient, covariates_c)

aldex_out_c <- asv_counts |>  
  left_join(anova_factors, by = c("sample" = "asv_counts.sample")) |>
  dplyr::filter(compartment == "leaves") |>
  dplyr::select(-c(compartment, interaction, treatment)) |>
  pivot_longer(names_to = "asv", values_to = "count", -c(sample)) |>  
  pivot_wider(names_from = sample, values_from = count, values_fill = 0) |>
  column_to_rownames("asv") |>
  dplyr::select(where(is.numeric)) |>
  aldex.clr(conds = mm_c) 
  
glm_out_c <- aldex.glm(aldex_out_c, verbose = TRUE)
glm_eff_c <- aldex.glm.effect(aldex_out_c, CI = TRUE)
```

```{r}
covariates_d <- anova_factors |> 
  dplyr::filter(compartment == "water_column") |> 
  dplyr::select(asv_counts.sample, treatment) |> 
  arrange(asv_counts.sample) |>
  mutate(value = 1) |> 
  pivot_wider(names_from = treatment, 
              values_from = value, values_fill = 0) |>
  dplyr::select(-asv_counts.sample)

mm_d <- model.matrix(~vent+ambient, covariates_d)

aldex_out_d <- asv_counts |>  
  left_join(anova_factors, by = c("sample" = "asv_counts.sample")) |>
  dplyr::filter(compartment == "water_column") |>
  dplyr::select(-c(compartment, interaction, treatment)) |>
  pivot_longer(names_to = "asv", values_to = "count", -c(sample)) |>  
  pivot_wider(names_from = sample, values_from = count, values_fill = 0) |>
  column_to_rownames("asv") |>
  dplyr::select(where(is.numeric)) |>
  aldex.clr(conds = mm_d) 
  
glm_out_d <- aldex.glm(aldex_out_c, verbose = TRUE)
glm_eff_d <- aldex.glm.effect(aldex_out_c, CI = TRUE)
```


